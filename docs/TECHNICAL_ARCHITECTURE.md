# GEDO.AI 技术架构文档

> 版本：v1.0 MVP  
> 更新日期：2025-12-23

---

## 目录

1. [技术栈总览](#1-技术栈总览)
2. [系统架构](#2-系统架构)
3. [数据库设计](#3-数据库设计)
4. [核心业务逻辑](#4-核心业务逻辑)
5. [AI 智能规划引擎](#5-ai-智能规划引擎)
6. [部署与运维](#6-部署与运维)

---

## 1. 技术栈总览

### 1.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Next.js** | 16.x (App Router) | 全栈框架，SSR/SSG/CSR 混合渲染 |
| **React** | 19.x | UI 组件库 |
| **TypeScript** | 5.x | 类型安全 |
| **Tailwind CSS** | 4.x | 原子化 CSS |
| **Framer Motion** | 11.x | 动画库（生命之树 SVG 动效） |
| **Lucide React** | - | 图标库 |

### 1.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Hono.js** | 4.x | 轻量级 API 框架 |
| **Node.js** | 20.x LTS | 运行时 |
| **PostgreSQL** | 16.x | 关系型数据库 |
| **pgvector** | 0.7.x | 向量存储扩展 |
| **JWT** | - | 无状态鉴权 |

### 1.3 AI/ML 技术栈

| 技术 | 用途 |
|------|------|
| **BGE-M3** | 多语言嵌入模型（检索） |
| **BGE-Reranker-v2-M3** | 重排序模型（精排） |
| **Qwen2.5** / **DeepSeek** | 开源大模型（规划/分析） |
| **OpenAI API** | 商用大模型备选 |

### 1.4 基础设施

| 服务 | 用途 |
|------|------|
| **Vercel** | 前端托管 |
| **Railway** / **Supabase** | PostgreSQL + pgvector |
| **Cloudflare R2** | 对象存储（语音/图片） |
| **Ollama** / **vLLM** | 本地大模型推理 |

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层 (User Layer)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌────────────┐  │
│   │   Web PC    │    │  Web Mobile │    │ Claude/IDE  │    │   Agent    │  │
│   │  (Next.js)  │    │ (响应式)    │    │  (MCP Client)│    │ (外部调用) │  │
│   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └─────┬──────┘  │
│          │                  │                  │                  │         │
└──────────┼──────────────────┼──────────────────┼──────────────────┼─────────┘
           │                  │                  │                  │
           ▼                  ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            接入层 (Gateway Layer)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────┐    ┌─────────────────────────────┐   │
│   │     Backend API (Hono.js)       │    │     MCP Server (Node.js)    │   │
│   │  - /v1/auth/*                   │    │  - 15 个标准工具            │   │
│   │  - /v1/memory/*                 │    │  - 会话管理                 │   │
│   │  - /v1/planner/*                │◄───│  - 工具路由                 │   │
│   │  - /v1/execution/*              │    └─────────────────────────────┘   │
│   │  - /v1/lifetree/*               │                                      │
│   └─────────────────┬───────────────┘                                      │
│                     │                                                       │
└─────────────────────┼───────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            业务层 (Service Layer)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│   │MemoryService │  │PlannerService│  │ExecutionSvc  │  │LifeTreeSvc   │   │
│   │- 记忆 CRUD   │  │- 目标生成    │  │- 任务管理    │  │- 快照聚合    │   │
│   │- 标签提取    │  │- SMART 拆解  │  │- 打卡记录    │  │- 平衡分析    │   │
│   │- 混合检索    │  │- 动态调整    │  │- 调整建议    │  │- 技能抽取    │   │
│   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
│          │                 │                 │                 │            │
└──────────┼─────────────────┼─────────────────┼─────────────────┼────────────┘
           │                 │                 │                 │
           ▼                 ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            智能层 (AI Layer)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      LLM Orchestration                               │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│   │  │PlannerAgent │  │ RecallAgent │  │AnalysisAgent│                  │   │
│   │  │- 目标澄清   │  │- 场景召回   │  │- 原因分析   │                  │   │
│   │  │- 任务拆解   │  │- 模式识别   │  │- 复盘生成   │                  │   │
│   │  │- 平衡建议   │  │- 日期提醒   │  │- 洞察抽取   │                  │   │
│   │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                  │   │
│   │         │                │                │                          │   │
│   │         ▼                ▼                ▼                          │   │
│   │  ┌──────────────────────────────────────────────────────────────┐   │   │
│   │  │                    LLM Provider Interface                     │   │   │
│   │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │   │   │
│   │  │  │ Ollama   │  │ vLLM     │  │ OpenAI   │  │ DeepSeek │      │   │   │
│   │  │  │(Qwen2.5) │  │(本地部署)│  │(GPT-4o)  │  │ (API)    │      │   │   │
│   │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘      │   │   │
│   │  └──────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      Embedding + Rerank                              │   │
│   │  ┌─────────────────────────┐  ┌─────────────────────────────────┐   │   │
│   │  │   BGE-M3 (Embedding)    │  │   BGE-Reranker-v2-M3 (Rerank)   │   │   │
│   │  │   - 1024 维向量         │  │   - Cross-Encoder 精排          │   │   │
│   │  │   - 多语言支持          │  │   - Top-K 重排序                │   │   │
│   │  └─────────────────────────┘  └─────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            数据层 (Data Layer)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    PostgreSQL + pgvector                             │   │
│   │                                                                      │   │
│   │   ┌─────────────────────────┐  ┌─────────────────────────────────┐  │   │
│   │   │    结构化存储 (SQL)      │  │    向量存储 (pgvector)          │  │   │
│   │   │  - users                │  │  - memories.embedding           │  │   │
│   │   │  - memories (关键记忆)  │  │  - 1024 维向量                  │  │   │
│   │   │  - skills               │  │  - IVFFlat 索引                 │  │   │
│   │   │  - goals                │  │  - 余弦相似度检索               │  │   │
│   │   │  - tasks                │  │                                  │  │   │
│   │   │  - check_ins            │  │                                  │  │   │
│   │   │  - adjustments          │  │                                  │  │   │
│   │   └─────────────────────────┘  └─────────────────────────────────┘  │   │
│   │                                                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                    Row Level Security (RLS)                  │   │   │
│   │   │   用户隔离：每个用户只能访问自己的数据                       │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────┐                                               │
│   │    对象存储 (R2/S3)     │                                               │
│   │  - 语音文件             │                                               │
│   │  - 图片附件             │                                               │
│   └─────────────────────────┘                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流向

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              核心数据流                                       │
└──────────────────────────────────────────────────────────────────────────────┘

1. 记忆录入流程
   用户输入 ──► 文本/语音/图片 ──► LLM 提取结构化信息 ──► BGE-M3 生成向量
                                          │
                                          ▼
                                   ┌──────────────┐
                                   │   memories   │
                                   │ - 结构化字段 │
                                   │ - 向量嵌入   │
                                   └──────────────┘

2. 记忆检索流程
   用户查询 ──► BGE-M3 编码 ──► 向量相似度检索 ──► BGE-Reranker 精排 ──► 返回结果
                                       │
                                       ▼
                              结合 SQL 条件筛选
                              (类型/标签/时间)

3. 目标规划流程
   目标描述 ──► RecallAgent 召回相关记忆 ──► PlannerAgent 澄清 ──► SMART 拆解
                                                                        │
                                                                        ▼
                                                              ┌──────────────────┐
                                                              │ goals + tasks    │
                                                              │ 关联 memories    │
                                                              └──────────────────┘

4. 执行反馈流程
   打卡记录 ──► 原因分析 ──► AnalysisAgent ──► 调整建议 ──► 更新任务/计划
                                  │
                                  ▼
                         ┌───────────────┐
                         │ check_ins     │
                         │ adjustments   │
                         │ reflections   │ ──► 写回 memories
                         └───────────────┘
```

---

## 3. 数据库设计

### 3.1 结构化 + 向量混合存储策略

#### 3.1.1 存储分类原则

| 分类 | 存储方式 | 数据类型 | 检索方式 |
|------|----------|----------|----------|
| **关键记忆** | 结构化字段 | 个人特征、性格、关键经历、技能、重要日期 | SQL 精确查询 |
| **辅助记忆** | 向量嵌入 | 一般信息、想法、笔记、会议内容 | 向量相似度 |
| **混合检索** | 两者结合 | 所有记忆都同时存储结构化和向量 | SQL + 向量 + Rerank |

#### 3.1.2 关键记忆（结构化存储）

```sql
-- memories 表的结构化字段
CREATE TABLE memories (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    
    -- 类型：决定是否为关键记忆
    type TEXT NOT NULL CHECK (type IN (
        'important_info',    -- 重要信息
        'personal_trait',    -- 个人特质（关键）
        'key_event',         -- 关键事件（关键）
        'date_reminder'      -- 日期提醒（关键）
    )),
    
    -- 原始内容
    content_raw TEXT NOT NULL,
    
    -- 结构化提取字段（关键记忆重点存储）
    content_struct JSONB DEFAULT '{}',
    -- content_struct 示例：
    -- {
    --   "people": ["张三", "李四"],           -- 涉及人物
    --   "dates": ["2024-03-15"],              -- 关键日期
    --   "skills": ["PPT制作", "数据分析"],    -- 技能关键词
    --   "traits": ["擅长沟通", "注重细节"],   -- 性格特征
    --   "emotions": ["自豪", "满足"],         -- 情绪标记
    --   "conclusions": ["方案获得认可"],      -- 关键结论
    --   "locations": ["北京", "会议室A"],     -- 地点
    --   "tags_auto": ["职场", "成就"]         -- 自动标签
    -- }
    
    -- 系统标签（四大类）
    system_tags TEXT[] DEFAULT '{}',
    -- ['self_awareness', 'growth_journey', 'goal_related', 'relationship']
    
    -- 重要度评分（用于排序和可视化）
    impact_score REAL DEFAULT 0.0,
    usage_count INTEGER DEFAULT 0,
    
    -- 关键日期（便于 SQL 查询）
    reminder_date DATE
);

-- 技能表（从记忆中抽取的关键能力）
CREATE TABLE skills (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    name TEXT NOT NULL,
    category TEXT,  -- 四大类之一
    proficiency_level REAL DEFAULT 0.0,
    evidence_count INTEGER DEFAULT 0,
    
    UNIQUE(user_id, name)
);

-- 技能-记忆关联（证据链）
CREATE TABLE skill_memories (
    skill_id UUID,
    memory_id UUID,
    PRIMARY KEY (skill_id, memory_id)
);
```

#### 3.1.3 辅助记忆（向量存储）

```sql
-- memories 表的向量字段
ALTER TABLE memories ADD COLUMN embedding vector(1024);

-- 创建 IVFFlat 索引（大规模检索）
CREATE INDEX idx_memories_embedding ON memories 
USING ivfflat (embedding vector_cosine_ops) 
WITH (lists = 100);

-- 向量相似度检索
SELECT id, content_raw, 
       1 - (embedding <=> $query_vector) as similarity
FROM memories
WHERE user_id = $user_id
ORDER BY embedding <=> $query_vector
LIMIT 20;
```

#### 3.1.4 混合检索流程

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           混合检索 (Hybrid Search)                           │
└──────────────────────────────────────────────────────────────────────────────┘

用户查询: "我之前参与过的产品相关经验"

Step 1: 查询理解
┌─────────────────────────────────────────────────────────────────────────────┐
│  LLM 分析查询意图                                                            │
│  - 关键词提取: ["产品", "经验", "参与"]                                      │
│  - 时间范围: 无限制                                                          │
│  - 类型偏好: key_event, personal_trait                                       │
│  - 标签偏好: growth_journey, goal_related                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
Step 2: 并行检索
┌─────────────────────────────┐    ┌─────────────────────────────────────────┐
│     结构化检索 (SQL)         │    │          向量检索 (pgvector)             │
│                             │    │                                          │
│  SELECT * FROM memories     │    │  SELECT * FROM memories                  │
│  WHERE user_id = $uid       │    │  WHERE user_id = $uid                    │
│    AND type IN ('key_event',│    │  ORDER BY embedding <=> $query_vec      │
│        'personal_trait')    │    │  LIMIT 50                                │
│    AND (                    │    │                                          │
│      content_struct @>      │    │  -- BGE-M3 编码查询                      │
│        '{"skills":["产品"]}' │   │  -- 返回 Top-50 候选                     │
│      OR system_tags &&      │    │                                          │
│        ARRAY['goal_related']│    │                                          │
│    )                        │    │                                          │
│  LIMIT 20                   │    │                                          │
└──────────────┬──────────────┘    └─────────────────┬───────────────────────┘
               │                                      │
               │              合并去重                │
               └──────────────────┬───────────────────┘
                                  │
                                  ▼
Step 3: 重排序 (Rerank)
┌─────────────────────────────────────────────────────────────────────────────┐
│  BGE-Reranker-v2-M3                                                          │
│                                                                              │
│  输入: [(query, candidate_1), (query, candidate_2), ...]                     │
│  输出: [score_1, score_2, ...] 按相关性排序                                  │
│                                                                              │
│  - Cross-Encoder 模型，更精确的相关性评估                                    │
│  - 考虑查询和文档的深度语义匹配                                              │
│  - 返回 Top-10 最相关结果                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
Step 4: 结果增强
┌─────────────────────────────────────────────────────────────────────────────┐
│  - 关联技能节点                                                              │
│  - 标注相关性说明（"可作为转型优势"）                                        │
│  - 按时间/重要度二次排序                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 完整 ER 图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据模型关系图                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                                  ┌──────────────┐
                                  │    users     │
                                  │──────────────│
                                  │ id (PK)      │
                                  │ email        │
                                  │ password_hash│
                                  │ display_name │
                                  │ preferences  │
                                  └──────┬───────┘
                                         │
           ┌─────────────────────────────┼─────────────────────────────┐
           │                             │                             │
           ▼                             ▼                             ▼
    ┌──────────────┐              ┌──────────────┐              ┌──────────────┐
    │   memories   │              │    goals     │              │life_wheel_   │
    │──────────────│              │──────────────│              │  weights     │
    │ id (PK)      │              │ id (PK)      │              │──────────────│
    │ user_id (FK) │              │ user_id (FK) │              │ user_id (FK) │
    │ type         │              │ title        │              │ health       │
    │ content_raw  │              │ description  │              │ career       │
    │ content_struct│             │ specific     │              │ family       │
    │ embedding    │◄────────────│ measurable   │              │ finance      │
    │ system_tags  │  关联召回    │ achievable   │              │ growth       │
    │ user_tags    │              │ relevant     │              │ social       │
    │ impact_score │              │ time_bound   │              │ hobby        │
    │ reminder_date│              │ level        │              │ self_realiz. │
    └──────┬───────┘              │ parent_id    │◄──┐          └──────────────┘
           │                      │ life_wheel_  │   │
           │                      │   dimension  │   │ 层级拆解
           │                      │ status       │   │
           │                      │ progress     │───┘
           │                      └──────┬───────┘
           │                             │
           │              ┌──────────────┴──────────────┐
           │              │                             │
           │              ▼                             ▼
           │       ┌──────────────┐              ┌──────────────┐
           │       │  plan_nodes  │              │    tasks     │
           │       │──────────────│              │──────────────│
           │       │ id (PK)      │              │ id (PK)      │
           │       │ goal_id (FK) │              │ goal_id (FK) │
           │       │ user_id (FK) │              │ plan_node_id │
           │       │ title        │              │ title        │
           │       │ granularity  │              │ estimated_   │
           │       │ parent_id    │◄──┐          │   duration   │
           │       │ status       │   │          │ energy_level │
           │       └──────────────┘   │          │ priority     │
           │                          │          │ status       │
           │              层级拆解 ───┘          │ scheduled_   │
           │                                     │   date       │
           │                                     └──────┬───────┘
           │                                            │
           ▼                                            ▼
    ┌──────────────┐                             ┌──────────────┐
    │    skills    │                             │  check_ins   │
    │──────────────│                             │──────────────│
    │ id (PK)      │                             │ id (PK)      │
    │ user_id (FK) │                             │ task_id (FK) │
    │ name         │                             │ user_id (FK) │
    │ category     │                             │ status       │
    │ proficiency  │                             │ reason_code  │
    │ evidence_cnt │                             │ reason_note  │
    └──────┬───────┘                             │ actual_dur.  │
           │                                     │ mood_rating  │
           │                                     └──────┬───────┘
           │                                            │
           ▼                                            ▼
    ┌──────────────┐                             ┌──────────────┐
    │skill_memories│                             │ adjustments  │
    │──────────────│                             │──────────────│
    │ skill_id(FK) │                             │ id (PK)      │
    │ memory_id(FK)│                             │ check_in_id  │
    └──────────────┘                             │ adjust_type  │
                                                 │ original_    │
           ┌─────────────────────────────────────│   task_id    │
           │                                     │ new_task_ids │
           │                                     │ ai_suggestion│
           │                                     └──────────────┘
           │
           ▼
    ┌──────────────┐
    │ reflections  │
    │──────────────│
    │ id (PK)      │
    │ user_id (FK) │
    │ goal_id (FK) │
    │ type         │
    │ content      │
    │ ai_insights  │
    │ memory_id    │◄─── 写回 memories
    └──────────────┘
```

### 3.3 向量维度选择

| 模型 | 向量维度 | 特点 |
|------|----------|------|
| **BGE-M3** | 1024 | 多语言、多任务，推荐 |
| OpenAI text-embedding-3-small | 1536 | 商用，高质量 |
| OpenAI text-embedding-3-large | 3072 | 商用，最高质量 |

**推荐配置**：使用 BGE-M3 的 1024 维，修改 schema：

```sql
-- 修改为 1024 维（适配 BGE-M3）
ALTER TABLE memories ALTER COLUMN embedding TYPE vector(1024);
```

---

## 4. 核心业务逻辑

### 4.1 领域模型关系

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           核心业务实体关系                                    │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   ┌───────────┐         影响          ┌───────────┐                        │
│   │  Memory   │ ──────────────────► │   Goal    │                        │
│   │  (记忆)   │     召回/关联        │  (目标)   │                        │
│   └─────┬─────┘                      └─────┬─────┘                        │
│         │                                  │                               │
│         │ 抽取                             │ 拆解                          │
│         ▼                                  ▼                               │
│   ┌───────────┐                      ┌───────────┐                        │
│   │   Skill   │                      │ PlanNode  │                        │
│   │  (技能)   │                      │  (计划)   │                        │
│   └───────────┘                      └─────┬─────┘                        │
│         │                                  │                               │
│         │ 证据                             │ 生成                          │
│         ▼                                  ▼                               │
│   ┌───────────────────────────────────────────────────────────────────┐   │
│   │                            Task (任务)                             │   │
│   │   - 日常行动项                                                     │   │
│   │   - 关联目标和计划                                                 │   │
│   │   - 能量/优先级标记                                                │   │
│   └─────────────────────────────────┬─────────────────────────────────┘   │
│                                     │                                      │
│                                     │ 打卡                                 │
│                                     ▼                                      │
│   ┌───────────────────────────────────────────────────────────────────┐   │
│   │                          CheckIn (打卡)                            │   │
│   │   - 完成状态                                                       │   │
│   │   - 未完成原因                                                     │   │
│   │   - 实际时长/心情                                                  │   │
│   └─────────────────────────────────┬─────────────────────────────────┘   │
│                                     │                                      │
│                     ┌───────────────┴───────────────┐                     │
│                     │                               │                      │
│                     ▼                               ▼                      │
│             ┌───────────┐                   ┌───────────┐                 │
│             │Adjustment │                   │Reflection │                 │
│             │ (调整)    │                   │ (复盘)    │                 │
│             └─────┬─────┘                   └─────┬─────┘                 │
│                   │                               │                        │
│                   │ 拆分/顺延                     │ 写回                   │
│                   ▼                               ▼                        │
│             ┌───────────┐                   ┌───────────┐                 │
│             │ 新 Tasks  │                   │ 新 Memory │                 │
│             └───────────┘                   └───────────┘                 │
│                                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 核心业务流程

#### 4.2.1 记忆沉淀流程

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              记忆沉淀流程                                     │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐
│  用户输入   │
│ 文本/语音/  │
│   图片      │
└──────┬──────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  Step 1: 内容处理                                                            │
│  - 语音: Whisper 转文本                                                      │
│  - 图片: OCR + 图像理解                                                      │
│  - 文本: 直接使用                                                            │
└───────────────────────────────────┬──────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  Step 2: LLM 结构化提取                                                      │
│                                                                              │
│  Prompt: "请从以下内容中提取结构化信息..."                                    │
│                                                                              │
│  输出:                                                                       │
│  {                                                                           │
│    "type": "key_event",                                                      │
│    "system_tags": ["growth_journey"],                                        │
│    "people": ["产品总监"],                                                   │
│    "skills": ["需求评审", "产品分析"],                                       │
│    "emotions": ["自豪"],                                                     │
│    "conclusions": ["方案获得认可"],                                          │
│    "is_key_memory": true  // 是否为关键记忆                                  │
│  }                                                                           │
└───────────────────────────────────┬──────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  Step 3: 向量化                                                              │
│                                                                              │
│  BGE-M3: content_raw → embedding[1024]                                       │
└───────────────────────────────────┬──────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  Step 4: 存储                                                                │
│                                                                              │
│  memories 表:                                                                │
│  - 结构化字段 (content_struct, system_tags, ...)                             │
│  - 向量字段 (embedding)                                                      │
│                                                                              │
│  如果提取到技能:                                                             │
│  - 更新/创建 skills 记录                                                     │
│  - 创建 skill_memories 关联                                                  │
└──────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.2 目标规划流程

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              目标规划流程                                     │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐
│  用户输入   │
│ "我想半年内 │
│  月薪涨30%" │
└──────┬──────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  Step 1: 记忆召回 (RecallAgent)                                              │
│                                                                              │
│  - 语义搜索相关经验                                                          │
│  - 搜索相关技能                                                              │
│  - 生成洞察: "你曾记录参与过3次产品需求评审，可作为转型优势"                  │
└───────────────────────────────────┬──────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  Step 2: 多轮澄清 (PlannerAgent)                                             │
│                                                                              │
│  Q1: "这个目标属于哪个维度？" → [事业] [成长] [财务]                          │
│  Q2: "你的当前薪资是多少？" → [文本输入]                                      │
│  Q3: "每天能投入多少时间？" → [30分钟] [1小时] [2小时]                        │
│  Q4: "如何衡量目标达成？" → [文本输入]                                        │
└───────────────────────────────────┬──────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  Step 3: SMART 目标生成                                                      │
│                                                                              │
│  Specific:   完成产品经理相关课程，主导1个产品项目                           │
│  Measurable: 通过内部产品经理认证考试                                        │
│  Achievable: 基于已有技术背景和产品评审经验                                  │
│  Relevant:   与职业发展规划一致                                              │
│  Time-bound: 6个月                                                           │
└───────────────────────────────────┬──────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  Step 4: 层级拆解                                                            │
│                                                                              │
│  Goal (6个月)                                                                │
│    └─ PlanNode (月度): M1 学习基础 → M2 实践 → M3 项目 → ...                 │
│         └─ PlanNode (周): W1 产品思维 → W2 需求分析 → ...                    │
│              └─ Task (日): 今天学习用户画像方法 (45分钟, 高能量)              │
└───────────────────────────────────┬──────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  Step 5: 生命之花平衡检查                                                    │
│                                                                              │
│  ⚠️ 检测到近期目标主要集中在"事业"维度                                       │
│  建议: 同步规划"每周1次家庭聚餐"，避免生活失衡                               │
└──────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.3 执行反馈闭环

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              执行反馈闭环                                     │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐
│  今日任务   │
│ TaskList    │
└──────┬──────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  用户打卡                                                                    │
│                                                                              │
│  [完成] → 记录 check_in (status=completed, actual_duration, mood)            │
│                                                                              │
│  [未完成] → 选择原因                                                         │
│    ├─ 时间不够                                                               │
│    ├─ 精力不足                                                               │
│    ├─ 优先级变更                                                             │
│    ├─ 外部打断                                                               │
│    └─ 其他                                                                   │
└───────────────────────────────────┬──────────────────────────────────────────┘
                                    │
                                    ▼ (如果未完成)
┌──────────────────────────────────────────────────────────────────────────────┐
│  AI 调整建议 (AnalysisAgent)                                                 │
│                                                                              │
│  原因: 时间不够                                                              │
│  建议: 将任务拆分为更小的部分                                                │
│                                                                              │
│  选项:                                                                       │
│  [A] 拆分为2个子任务，每个约15-20分钟                                        │
│  [B] 拆分为3个子任务，每个约10-15分钟                                        │
│  [C] 缩小任务范围，只完成核心部分                                            │
└───────────────────────────────────┬──────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  执行调整                                                                    │
│                                                                              │
│  - 创建 adjustment 记录                                                      │
│  - 拆分/顺延/取消原任务                                                      │
│  - 生成新任务                                                                │
└───────────────────────────────────┬──────────────────────────────────────────┘
                                    │
                                    ▼ (周期性)
┌──────────────────────────────────────────────────────────────────────────────┐
│  复盘总结                                                                    │
│                                                                              │
│  - 统计完成率、常见未完成原因                                                │
│  - 生成 AI 洞察                                                              │
│  - 创建 reflection 记录                                                      │
│  - 写回 memory (形成经验沉淀)                                                │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. AI 智能规划引擎

### 5.1 大模型选型

#### 5.1.1 推荐配置

| 用途 | 推荐模型 | 部署方式 | 备选 |
|------|----------|----------|------|
| **目标规划/拆解** | Qwen2.5-7B-Instruct | Ollama 本地 | DeepSeek API |
| **记忆提取/分析** | Qwen2.5-7B-Instruct | Ollama 本地 | GPT-4o-mini |
| **复盘洞察** | Qwen2.5-14B-Instruct | vLLM 本地 | GPT-4o |
| **嵌入模型** | BGE-M3 | 本地部署 | OpenAI embedding |
| **重排模型** | BGE-Reranker-v2-M3 | 本地部署 | Cohere Rerank |

#### 5.1.2 Ollama 本地部署

```bash
# 安装 Ollama
curl -fsSL https://ollama.com/install.sh | sh

# 下载模型
ollama pull qwen2.5:7b-instruct
ollama pull bge-m3
ollama pull bge-reranker-v2-m3

# 启动服务
ollama serve
```

#### 5.1.3 LLM Provider 接口

```javascript
// services/backend-api/src/llm/provider.mjs

export class LLMProvider {
  constructor(config) {
    this.config = config;
  }

  async chat(messages, options = {}) {
    throw new Error('Not implemented');
  }

  async embed(text) {
    throw new Error('Not implemented');
  }
}

// Ollama 实现
export class OllamaProvider extends LLMProvider {
  constructor(config = {}) {
    super(config);
    this.baseUrl = config.baseUrl || 'http://localhost:11434';
    this.model = config.model || 'qwen2.5:7b-instruct';
    this.embedModel = config.embedModel || 'bge-m3';
  }

  async chat(messages, options = {}) {
    const response = await fetch(`${this.baseUrl}/api/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: this.model,
        messages,
        stream: false,
        options: {
          temperature: options.temperature || 0.7,
        },
      }),
    });
    
    const data = await response.json();
    return { content: data.message.content };
  }

  async embed(text) {
    const response = await fetch(`${this.baseUrl}/api/embeddings`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: this.embedModel,
        prompt: text,
      }),
    });
    
    const data = await response.json();
    return data.embedding; // [1024]
  }
}

// DeepSeek API 实现
export class DeepSeekProvider extends LLMProvider {
  constructor(config) {
    super(config);
    this.apiKey = config.apiKey;
    this.baseUrl = 'https://api.deepseek.com';
  }

  async chat(messages, options = {}) {
    const response = await fetch(`${this.baseUrl}/v1/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.apiKey}`,
      },
      body: JSON.stringify({
        model: 'deepseek-chat',
        messages,
        temperature: options.temperature || 0.7,
      }),
    });
    
    const data = await response.json();
    return { content: data.choices[0].message.content };
  }
}

// OpenAI 实现
export class OpenAIProvider extends LLMProvider {
  constructor(config) {
    super(config);
    this.apiKey = config.apiKey;
    this.model = config.model || 'gpt-4o-mini';
    this.embedModel = config.embedModel || 'text-embedding-3-small';
  }

  async chat(messages, options = {}) {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.apiKey}`,
      },
      body: JSON.stringify({
        model: this.model,
        messages,
        temperature: options.temperature || 0.7,
        response_format: options.json ? { type: 'json_object' } : undefined,
      }),
    });
    
    const data = await response.json();
    return { content: data.choices[0].message.content };
  }

  async embed(text) {
    const response = await fetch('https://api.openai.com/v1/embeddings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.apiKey}`,
      },
      body: JSON.stringify({
        model: this.embedModel,
        input: text,
      }),
    });
    
    const data = await response.json();
    return data.data[0].embedding;
  }
}
```

### 5.2 SMART 目标生成

```javascript
// services/agent/src/prompts/smart.mjs

export const SMART_GOAL_PROMPT = `你是一个专业的目标规划师。请将用户的目标描述转化为 SMART 格式。

## SMART 原则
- **Specific（具体）**：明确要做什么，避免模糊
- **Measurable（可衡量）**：有明确的数字指标或可验证的标准
- **Achievable（可实现）**：基于现有资源和能力可以达成
- **Relevant（相关）**：与用户的价值观和长期目标一致
- **Time-bound（有时限）**：有明确的截止日期

## 用户信息
{user_context}

## 相关记忆
{related_memories}

## 用户的目标描述
{goal_prompt}

## 用户的回答
{user_answers}

## 输出要求
请输出 JSON 格式：
{
  "goal": {
    "title": "目标标题（简洁）",
    "description": "详细描述",
    "specific": "具体要做什么",
    "measurable": "如何衡量成功",
    "achievable": "为什么这个目标是可实现的",
    "relevant": "与用户生活的相关性",
    "time_bound": "截止时间",
    "dimension": "health|career|family|finance|growth|social|hobby|self_realization"
  },
  "milestones": [
    {
      "title": "里程碑标题",
      "target_date": "YYYY-MM-DD",
      "criteria": "完成标准"
    }
  ],
  "initial_tasks": [
    {
      "title": "任务标题",
      "scheduled_date": "YYYY-MM-DD",
      "estimated_duration": 30,
      "energy_level": "low|medium|high",
      "priority": 1-5
    }
  ],
  "balance_warning": "生命之花平衡提醒（如果有）"
}`;

export const TASK_DECOMPOSITION_PROMPT = `你是一个任务拆解专家。请将目标拆解为具体的行动计划。

## 拆解原则
1. **层级递进**：年 → 季度 → 月 → 周 → 日
2. **颗粒度适中**：每个任务 15-60 分钟可完成
3. **能量匹配**：标注每个任务需要的能量等级
4. **时间感知**：考虑用户的可用时间

## 目标信息
{goal_info}

## 用户的时间约束
{time_constraints}

## 输出 JSON 格式
{
  "plan_nodes": [
    {
      "title": "计划节点",
      "granularity": "month|week|day",
      "start_date": "YYYY-MM-DD",
      "end_date": "YYYY-MM-DD",
      "sub_nodes": [...],
      "tasks": [...]
    }
  ]
}`;
```

### 5.3 动态调整机制

```javascript
// services/agent/src/prompts/adjustment.mjs

export const ADJUSTMENT_ANALYSIS_PROMPT = `你是一个计划调整分析师。用户没有完成某个任务，请分析原因并提供调整建议。

## 任务信息
- 标题: {task_title}
- 预计时长: {estimated_duration} 分钟
- 能量等级: {energy_level}
- 优先级: {priority}

## 未完成原因
代码: {reason_code}
备注: {reason_note}

## 用户历史模式
{user_patterns}

## 分析并输出 JSON
{
  "analysis": {
    "root_cause": "根本原因分析",
    "pattern_detected": "是否检测到重复模式",
    "urgency": "high|medium|low"
  },
  "adjustment": {
    "type": "split|reschedule|postpone|reduce|cancel",
    "reason": "调整原因",
    "suggestion": {
      "message": "给用户的建议说明",
      "options": [
        {
          "id": "opt1",
          "label": "选项说明",
          "action": "具体操作",
          "new_tasks": [...]  // 如果是拆分
        }
      ]
    }
  },
  "prevention": "预防建议（避免下次发生）"
}`;

// 调整类型处理逻辑
export const ADJUSTMENT_HANDLERS = {
  // 任务拆分
  split: async (task, options, ctx) => {
    const splitCount = parseInt(options.action.split('_')[1]) || 2;
    const newDuration = Math.ceil(task.estimated_duration / splitCount);
    
    const newTasks = [];
    for (let i = 0; i < splitCount; i++) {
      newTasks.push({
        title: `${task.title} (Part ${i + 1})`,
        goal_id: task.goal_id,
        estimated_duration: newDuration,
        energy_level: 'low', // 拆分后降低能量要求
        priority: task.priority,
        scheduled_date: getNextAvailableDate(ctx, i),
      });
    }
    
    return { originalStatus: 'skipped', newTasks };
  },
  
  // 重新安排
  reschedule: async (task, options, ctx) => {
    const newDate = calculateNewDate(options.action, ctx);
    return {
      originalStatus: 'pending',
      updates: { scheduled_date: newDate },
    };
  },
  
  // 顺延
  postpone: async (task, options, ctx) => {
    const days = parseInt(options.action.split('_')[1]) || 1;
    const newDate = addDays(task.scheduled_date, days);
    return {
      originalStatus: 'postponed',
      updates: { scheduled_date: newDate },
    };
  },
  
  // 缩小范围
  reduce: async (task, options, ctx) => {
    return {
      originalStatus: 'pending',
      updates: {
        title: `${task.title} (精简版)`,
        estimated_duration: Math.ceil(task.estimated_duration * 0.5),
      },
    };
  },
  
  // 取消
  cancel: async (task) => {
    return { originalStatus: 'cancelled', newTasks: [] };
  },
};
```

### 5.4 生命之花平衡模型

```javascript
// services/agent/src/lifewheel.mjs

/**
 * 生命之花 8 大维度
 */
export const LIFE_WHEEL_DIMENSIONS = {
  health: { 
    label: '健康', 
    color: '#10b981',
    examples: ['运动', '饮食', '睡眠', '体检', '心理健康']
  },
  career: { 
    label: '事业', 
    color: '#3b82f6',
    examples: ['工作技能', '晋升', '项目', '人脉', '行业影响力']
  },
  family: { 
    label: '家庭', 
    color: '#f59e0b',
    examples: ['陪伴家人', '家庭活动', '育儿', '婚姻关系', '孝顺父母']
  },
  finance: { 
    label: '财务', 
    color: '#8b5cf6',
    examples: ['收入', '储蓄', '投资', '理财', '财务自由']
  },
  growth: { 
    label: '成长', 
    color: '#06b6d4',
    examples: ['学习', '阅读', '技能提升', '认知升级', '思维模型']
  },
  social: { 
    label: '社交', 
    color: '#ec4899',
    examples: ['朋友', '社群', '社会贡献', '人际关系', '社交活动']
  },
  hobby: { 
    label: '兴趣', 
    color: '#f97316',
    examples: ['爱好', '娱乐', '创作', '旅行', '探索']
  },
  self_realization: { 
    label: '自我实现', 
    color: '#6366f1',
    examples: ['人生意义', '价值观', '使命', '精神追求', '自我超越']
  },
};

/**
 * 计算生命之花平衡度
 */
export function calculateBalance(goals) {
  const dimensions = Object.keys(LIFE_WHEEL_DIMENSIONS);
  const counts = {};
  const activeGoals = goals.filter(g => g.status === 'active');
  
  // 统计各维度目标数量
  dimensions.forEach(dim => { counts[dim] = 0; });
  activeGoals.forEach(g => {
    if (g.life_wheel_dimension) {
      counts[g.life_wheel_dimension]++;
    }
  });
  
  // 计算平衡指标
  const values = Object.values(counts);
  const total = values.reduce((a, b) => a + b, 0);
  const max = Math.max(...values);
  const nonZeroCount = values.filter(v => v > 0).length;
  
  // 平衡分数 (0-100)
  // - 维度覆盖度 (有多少维度有目标)
  // - 分布均匀度 (目标是否集中在少数维度)
  const coverageScore = (nonZeroCount / dimensions.length) * 50;
  const distributionScore = total > 0 
    ? (1 - (max / total)) * 50 
    : 50;
  
  return {
    score: Math.round(coverageScore + distributionScore),
    counts,
    coverage: nonZeroCount,
    total: dimensions.length,
    warnings: generateBalanceWarnings(counts, total),
  };
}

/**
 * 生成平衡警告
 */
function generateBalanceWarnings(counts, total) {
  const warnings = [];
  const dimensions = Object.keys(LIFE_WHEEL_DIMENSIONS);
  
  // 检查过度集中
  Object.entries(counts).forEach(([dim, count]) => {
    if (total > 0 && count / total > 0.4) {
      warnings.push({
        type: 'concentration',
        dimension: dim,
        message: `目标过于集中在"${LIFE_WHEEL_DIMENSIONS[dim].label}"维度，建议关注其他维度`,
      });
    }
  });
  
  // 检查空缺维度
  const emptyDimensions = dimensions.filter(d => counts[d] === 0);
  if (emptyDimensions.length >= 4) {
    warnings.push({
      type: 'gaps',
      dimensions: emptyDimensions,
      message: `有 ${emptyDimensions.length} 个维度没有目标，考虑平衡发展`,
    });
  }
  
  // 检查关键维度
  if (counts.health === 0) {
    warnings.push({
      type: 'critical',
      dimension: 'health',
      message: '健康是其他一切的基础，建议设定至少一个健康相关目标',
    });
  }
  
  return warnings;
}

/**
 * 生成平衡建议
 */
export const BALANCE_SUGGESTION_PROMPT = `你是一个生活平衡顾问。请基于用户的生命之花现状，提供平衡建议。

## 生命之花模型
8个维度：健康、事业、家庭、财务、成长、社交、兴趣、自我实现

## 用户现状
当前目标分布: {dimension_counts}
平衡分数: {balance_score}/100
警告: {warnings}

## 用户即将创建的目标
维度: {new_goal_dimension}
标题: {new_goal_title}

## 输出要求
1. 评估这个新目标对平衡的影响
2. 如果会加剧失衡，提供补充建议
3. 输出 JSON:

{
  "impact": "positive|neutral|negative",
  "analysis": "影响分析",
  "suggestions": [
    {
      "dimension": "建议补充的维度",
      "goal_idea": "目标建议",
      "reason": "为什么重要"
    }
  ]
}`;
```

### 5.5 完整 Agent 调用流程

```javascript
// services/backend-api/src/services/planner.service.mjs

import { PlannerAgent, RecallAgent } from '@gedo/agent';
import { OllamaProvider } from '../llm/provider.mjs';
import { calculateBalance } from './lifewheel.mjs';

export class PlannerService {
  constructor(db, llmProvider) {
    this.db = db;
    this.llm = llmProvider || new OllamaProvider();
  }

  /**
   * 创建目标的完整流程
   */
  async createGoal(userId, prompt) {
    // 1. 初始化 Agents
    const token = await this.getTokenForUser(userId);
    const planner = new PlannerAgent(token, this.llm);
    const recall = new RecallAgent(token, this.llm);
    
    // 2. 召回相关记忆
    const relatedContext = await recall.recallForGoalCreation(prompt);
    
    // 3. 生成澄清问题
    const clarification = await planner.clarifyGoal(prompt, relatedContext.relatedMemories);
    
    return {
      step: 'clarify',
      questions: clarification.questions,
      suggestedDimension: clarification.suggestedDimension,
      relatedMemories: relatedContext.relatedMemories,
      insights: relatedContext.insights,
    };
  }

  /**
   * 处理澄清回答，生成 SMART 目标
   */
  async processAnswers(userId, prompt, answers) {
    const planner = new PlannerAgent(token, this.llm);
    
    // 1. 生成 SMART 目标
    const result = await planner.generateSMARTGoal(prompt, answers);
    
    // 2. 检查生命之花平衡
    const existingGoals = await this.db.getGoals(userId, { status: 'active' });
    const balance = calculateBalance([...existingGoals, { 
      life_wheel_dimension: result.goal.dimension 
    }]);
    
    // 3. 如果失衡，添加警告
    if (balance.score < 50 || balance.warnings.length > 0) {
      result.balanceWarning = balance.warnings[0]?.message;
      result.balanceSuggestions = await this.generateBalanceSuggestions(
        balance, 
        result.goal.dimension
      );
    }
    
    return {
      step: 'review',
      goal: result.goal,
      tasks: result.initial_tasks,
      balanceWarning: result.balanceWarning,
      balanceSuggestions: result.balanceSuggestions,
    };
  }

  /**
   * 确认创建目标
   */
  async confirmGoal(userId, goalData, tasks) {
    // 1. 保存目标
    const goal = await this.db.createGoal({
      ...goalData,
      user_id: userId,
      status: 'active',
      progress: 0,
    });
    
    // 2. 创建初始任务
    for (const task of tasks) {
      await this.db.createTask({
        ...task,
        user_id: userId,
        goal_id: goal.id,
        status: 'pending',
      });
    }
    
    // 3. 更新生命之花权重（可选）
    await this.updateLifeWheelWeights(userId, goalData.dimension);
    
    return { goal, tasks };
  }

  /**
   * 处理打卡并生成调整建议
   */
  async handleCheckIn(userId, taskId, status, reasonCode, reasonNote) {
    // 1. 记录打卡
    const checkIn = await this.db.createCheckIn({
      task_id: taskId,
      user_id: userId,
      status,
      reason_code: reasonCode,
      reason_note: reasonNote,
    });
    
    // 2. 如果未完成，生成调整建议
    if (status !== 'completed' && reasonCode) {
      const task = await this.db.getTask(taskId);
      const planner = new PlannerAgent(token, this.llm);
      
      const adjustment = await planner.generateAdjustment(task, reasonCode, reasonNote);
      
      // 保存调整建议
      await this.db.createAdjustment({
        user_id: userId,
        trigger_check_in_id: checkIn.id,
        adjustment_type: adjustment.adjustmentType,
        original_task_id: taskId,
        reason: adjustment.reason,
        ai_suggestion: adjustment.suggestion,
        accepted: null, // 等待用户确认
      });
      
      return { checkIn, adjustment };
    }
    
    return { checkIn };
  }
}
```

---

## 6. 部署与运维

### 6.1 环境配置

```bash
# .env.example

# 数据库
DATABASE_URL=postgresql://user:pass@localhost:5432/gedoai

# JWT
JWT_SECRET=your-secret-key

# LLM 配置
LLM_PROVIDER=ollama  # ollama | deepseek | openai
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=qwen2.5:7b-instruct
OLLAMA_EMBED_MODEL=bge-m3

# 备选 API
DEEPSEEK_API_KEY=
OPENAI_API_KEY=

# 对象存储
R2_ACCOUNT_ID=
R2_ACCESS_KEY=
R2_SECRET_KEY=
R2_BUCKET=gedo-uploads
```

### 6.2 Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQL + pgvector
  postgres:
    image: ankane/pgvector:latest
    environment:
      POSTGRES_USER: gedo
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: gedoai
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./services/backend-api/db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    ports:
      - "5432:5432"

  # Ollama (本地 LLM)
  ollama:
    image: ollama/ollama:latest
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # Backend API
  backend:
    build:
      context: ./services/backend-api
    environment:
      DATABASE_URL: postgresql://gedo:secret@postgres:5432/gedoai
      OLLAMA_BASE_URL: http://ollama:11434
    ports:
      - "8787:8787"
    depends_on:
      - postgres
      - ollama

  # MCP Server
  mcp:
    build:
      context: ./services/mcp-server
    environment:
      API_BASE_URL: http://backend:8787
    ports:
      - "8788:8788"
    depends_on:
      - backend

  # Frontend (开发模式)
  web:
    build:
      context: ./GedoAIWeb
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8787
    ports:
      - "3000:3000"
    depends_on:
      - backend

volumes:
  pgdata:
  ollama_data:
```

### 6.3 性能优化

```sql
-- 数据库索引优化

-- 记忆表索引
CREATE INDEX idx_memories_user_type ON memories(user_id, type);
CREATE INDEX idx_memories_user_tags ON memories USING GIN(system_tags);
CREATE INDEX idx_memories_reminder ON memories(reminder_date) WHERE reminder_date IS NOT NULL;
CREATE INDEX idx_memories_struct ON memories USING GIN(content_struct);

-- 向量索引 (IVFFlat, 需要先插入数据再创建)
CREATE INDEX idx_memories_embedding ON memories 
USING ivfflat (embedding vector_cosine_ops) 
WITH (lists = 100);

-- 任务表索引
CREATE INDEX idx_tasks_user_date ON tasks(user_id, scheduled_date);
CREATE INDEX idx_tasks_goal ON tasks(goal_id);

-- 目标表索引
CREATE INDEX idx_goals_user_status ON goals(user_id, status);
CREATE INDEX idx_goals_dimension ON goals(life_wheel_dimension);
```

---

## 附录

### A. 参考资料

- [BGE-M3 模型](https://huggingface.co/BAAI/bge-m3)
- [BGE-Reranker-v2-M3](https://huggingface.co/BAAI/bge-reranker-v2-m3)
- [pgvector 文档](https://github.com/pgvector/pgvector)
- [Ollama 文档](https://ollama.ai/library)
- [Next.js App Router](https://nextjs.org/docs/app)

### B. 术语表

| 术语 | 解释 |
|------|------|
| SMART | Specific, Measurable, Achievable, Relevant, Time-bound |
| RAG | Retrieval-Augmented Generation，检索增强生成 |
| RLS | Row Level Security，行级安全 |
| MCP | Model Context Protocol，模型上下文协议 |
| pgvector | PostgreSQL 向量扩展 |
| IVFFlat | Inverted File with Flat Quantization，向量索引类型 |





